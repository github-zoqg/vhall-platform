<template>
  <div class="vmp-footer-tools" v-if="!isEmbedVideo">
    <div class="vmp-footer-tools__left">
      <div class="vmp-footer-tools__left-setting" v-if="isInteractLive" @click="settingShow">
        <i class="vh-iconfont vh-line-setting"></i>
        {{ $t('account.account_1005') }}
      </div>
      <div class="vmp-footer-tools__left-online" v-if="roomBaseState.watchInitData.online.show">
        <i class="vh-iconfont vh-line-user"></i>
        {{ onlineNum | formatHotNum }}
      </div>
      <div class="vmp-footer-tools__left-hot" v-if="roomBaseState.watchInitData.pv.show">
        <i class="vh-saas-iconfont vh-saas-line-heat"></i>
        {{ hotNum | formatHotNum }}
      </div>
      <div class="vmp-footer-tools__left-language" v-if="isEmbed && languageList.length > 1">
        <el-dropdown @command="changeLang" trigger="click" placement="bottom">
          <span class="language__icon">
            <i class="vh-saas-iconfont vh-saas-line-multilingual"></i>
            {{ lang.label }}
          </span>
          <el-dropdown-menu slot="dropdown">
            <el-dropdown-item
              :command="item.key"
              :key="index"
              :class="{ active: item.key == lang.key }"
              v-for="(item, index) in languageList"
            >
              {{ item.label }}
            </el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>
      </div>
    </div>
    <!-- 上下麦按钮 -->
    <div class="vmp-footer-tools__center" v-if="device_status === 1 && !isBanned && isInteractLive">
      <handup></handup>
    </div>
    <!-- 互动工具 -->
    <ul v-if="!isTrySee && !isInGroup" class="vmp-footer-tools__right">
      <li v-if="isLiving">
        <!-- 公告 直播显示公告 -->
        <notice></notice>
      </li>
      <li v-if="isLiving">
        <!-- 计时器 -->
        <div v-if="openTimer" class="pr">
          <i v-if="showTimer" class="circle"></i>
          <img src="./img/timer.png" alt="" @click="openTimerHandle" />
        </div>
        <vmp-air-container :cuid="childrenCom[1]" :oneself="true"></vmp-air-container>
      </li>
      <li>
        <!-- 问卷-->
        <questionnaire-icon @clickIcon="checkQuestionIcon" />
      </li>
      <li>
        <!-- 签到 -->
        <vmp-air-container :cuid="childrenCom[0]" :oneself="true"></vmp-air-container>
      </li>
      <li v-if="isLiving">
        <!-- 抽奖 -->
        <lottery-icon @clickIcon="checkLotteryIcon" />
      </li>
      <li>
        <red-packet-icon @clickIcon="checkredPacketIcon" />
        <!-- 红包 -->
      </li>
      <li v-if="showGiftIcon && roomBaseState.configList['ui.hide_gifts'] == '0'">
        <!-- 礼物 -->
        <div class="vh-gifts-wrap">
          <img src="./img/iconGifts@2x.png" @click.stop="handleShowGift" />
          <!-- showCount展示次数，只有第一次点击礼物图标的时候才会调接口 -->
          <vh-gifts
            v-show="showGift && roomBaseState.watchInitData.interact.room_id"
            :roomId="roomBaseState.watchInitData.interact.room_id"
            :show-gift-count="showGiftCount"
            @changeShowGift="changeStatus"
            @acceptPay="acceptPay"
            @needLogin="needLogin"
          />
        </div>
      </li>
      <li v-if="roomBaseState.configList['ui.hide_reward'] == '0'">
        <!-- 打赏 -->
        <div class="vh-icon-box">
          <img src="./img/reward-icon.png" alt="" @click="onClickReward" />
          <reward ref="reward" />
        </div>
      </li>
      <li v-if="roomBaseState.configList['ui.watch_hide_like'] == '0'">
        <!-- 点赞 -->
        <praise></praise>
      </li>
      <!-- 支付弹框 -->
      <li v-if="showPay">
        <Pay
          :wxQr="wxQr"
          :zfQr="zfQr"
          @changeShow="changeStatus"
          :style="{ zIndex: zIndexServerState.zIndexMap.giftPay }"
        ></Pay>
      </li>
    </ul>
  </div>
</template>
<script>
  import { boxEventOpitons } from '@/packages/app-shared/utils/tool.js';
  import {
    useRoomBaseServer,
    useZIndexServer,
    useMicServer,
    useChatServer,
    useGroupServer
  } from 'middle-domain';
  import handup from './handup.vue';
  import reward from './component/reward/index.vue';
  import vhGifts from './component/gifts/index.vue';
  import notice from './component/notice/index.vue';
  import praise from './component/praise/index.vue';
  import Pay from './component/pay/index.vue';
  import RedPacketIcon from './component/red-packet-icon/index.vue';
  import QuestionnaireIcon from './component/questionnaire-icon/index.vue';
  import LotteryIcon from './component/lottery-icon/index.vue';
  export default {
    name: 'VmpFooterTools',
    components: {
      handup,
      reward,
      vhGifts,
      notice,
      praise,
      Pay,
      RedPacketIcon,
      QuestionnaireIcon,
      LotteryIcon
    },
    data() {
      const zIndexServerState = this.zIndexServer.state;
      return {
        zIndexServerState,
        roomBaseState: null,
        showGiftIcon: true,
        showGift: false,
        showGiftCount: 0,
        openTimer: false,
        showTimer: false,
        groupInitData: {},
        showPay: false,
        zfQr: '',
        wxQr: '',
        lang: {},
        languageList: []
      };
    },
    filters: {
      formatHotNum(value) {
        value = parseInt(value);
        let unit = '';
        const k = 99999;
        const sizes = ['', '万', '亿', '万亿'];
        let i;
        if (value > k) {
          i = Math.floor(Math.log(value) / Math.log(k));
          value = (value / Math.pow(k / 10, i)).toFixed(1);
          unit = sizes[i];
        }
        return value + unit;
      }
    },
    computed: {
      // 是否已上麦
      isSpeakOn() {
        return this.$domainStore.state.micServer.isSpeakOn;
      },
      isInteractLive() {
        const { watchInitData } = this.roomBaseState;
        return (
          (watchInitData.webinar.mode == 3 || watchInitData.webinar.mode == 6) &&
          watchInitData.webinar.type == 1
        );
      },
      // 是否正在直播
      isLiving() {
        return this.$domainStore.state.roomBaseServer.watchInitData.webinar.type == 1;
      },
      isTrySee() {
        const { watchInitData } = this.roomBaseState;
        return (
          watchInitData.status == 'subscribe' &&
          watchInitData.preview_paas_record_id &&
          watchInitData.is_subscribe == 0
        );
      },
      isInGroup() {
        return this.groupServer.state.groupInitData.isInGroup;
      },
      hotNum() {
        return (
          Number(this.$domainStore.state.virtualAudienceServer.uvHot) +
          Number(this.$domainStore.state.virtualAudienceServer.virtualHot) +
          1
        );
      },
      onlineNum() {
        return (
          Number(this.$domainStore.state.virtualAudienceServer.uvOnline) +
          Number(this.$domainStore.state.virtualAudienceServer.virtualOnline)
        );
      },
      isEmbed() {
        // 是不是嵌入
        return this.$domainStore.state.roomBaseServer.embedObj.embed;
      },
      isEmbedVideo() {
        // 是不是音视频嵌入
        return this.$domainStore.state.roomBaseServer.embedObj.embedVideo;
      },
      device_status() {
        // 设备状态  0未检测 1可以上麦 2不可以上麦
        return this.$domainStore.state.mediaCheckServer.deviceInfo.device_status;
      },
      isBanned() {
        return !this.isInGroup && (useChatServer().state.banned || useChatServer().state.allBanned); //true禁言，false未禁言
      }
    },
    beforeCreate() {
      this.zIndexServer = useZIndexServer();
      this.roomBaseServer = useRoomBaseServer();
      this.groupServer = useGroupServer();
    },
    created() {
      this.childrenCom = window.$serverConfig[this.cuid].children;
      this.roomBaseState = this.roomBaseServer.state;
      if (this.isEmbed) {
        this.languageList = this.roomBaseState.languages.langList;
        this.lang = this.roomBaseServer.state.languages.lang;
      }
      this.groupState = this.groupServer.state;
      window.addEventListener('click', () => {
        if (this.showGift) {
          this.showGift = false;
        }
      });
      if (this.isSpeakOn && useChatServer().state.allBanned) {
        useMicServer().speakOff();
      }
    },
    methods: {
      settingShow() {
        window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitClickMediaSetting'));
      },
      changeStatus(data, status) {
        console.log(data, status, 'data, status');
        this[data] = status;
      },
      // 打开计时器弹框
      openTimerHandle() {
        window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitOpenTimer'));
        this.changeStatus('showTimer', false);
      },
      // 打开礼物弹框
      handleShowGift() {
        this.showGift = !this.showGift;
        if (this.showGift) {
          this.showGiftCount++;
        }
        // TODO:是否需要处理
        this.$refs.notice && (this.$refs.notice.isShowNotice = false);
      },
      // 打开打赏弹框
      onClickReward() {
        // 需校验是否登陆
        if (this.roomBaseState.watchInitData.join_info.user_id == 0) {
          this.needLogin();
          // window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitNeedLogin'));
          return false;
        }
        this.$refs.reward.onClickReward();
      },
      // 接收支付码
      acceptPay(data, url) {
        // 修改付费礼物支付弹窗层级
        this.zIndexServer.setDialogZIndex('giftPay');
        this.showPay = true;
        this[data] = url;
      },
      changeLang(key) {
        localStorage.setItem('lang', key);
        window.location.reload();
      },
      needLogin() {
        window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitNeedLogin'));
      },
      checkLotteryIcon() {
        window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitClickLotteryIcon'));
      },
      checkredPacketIcon(redPacketId) {
        window.$middleEventSdk?.event?.send(
          boxEventOpitons(this.cuid, 'emitClickRedPacketIcon', [redPacketId])
        );
      },
      checkQuestionIcon(questionnaireId) {
        window.$middleEventSdk?.event?.send(
          boxEventOpitons(this.cuid, 'emitClickQuestionIcon', [questionnaireId])
        );
      }
    }
  };
</script>
<style lang="less">
  .vmp-footer-tools {
    height: 56px;
    background: @bg-dark-section;
    line-height: 56px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    position: relative;
    // z-index: 10;

    &__left {
      display: flex;
      align-items: center;
      color: @font-dark-normal;
      font-size: 14px;
      > div {
        margin-right: 16px;
        .iconfont {
          vertical-align: bottom;
        }
      }
      &-setting {
        cursor: pointer;
      }
      &-language {
        .language__icon {
          color: #ccc;
          cursor: pointer;
        }
      }
    }
    &__right {
      display: flex;
      align-items: center;
      color: @font-dark-normal;
      font-size: 14px;
      > div {
        margin-left: 16px;
      }
      li > div > img {
        width: 32px;
        height: 32px;
        margin-left: 16px;
        border-radius: 16px;
        cursor: pointer;
      }
      .vh-gifts-wrap {
        border-radius: 16px;
        position: relative;
      }
    }
    &__center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .circle {
      position: absolute;
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #fb3a32;
      border: 1px solid #2a2a2a;
      border-radius: 50%;
      top: 10px;
      right: 0px;
      position: absolute;
    }
    .pr {
      position: relative;
    }
  }
</style>
