<template>
  <div class="vmp-live-timer">
    <div v-if="timerVisible" class="background-img" v-drag>
      <el-row class="padding45">
        <el-row
          :class="
            status == 'timeout'
              ? 'pause_font_color'
              : status == 'start'
              ? 'start_font_color'
              : 'timeout_font_color'
          "
        >
          <el-col align="center" class="ft14">
            <div v-if="time < 0">超时，开始正向计时</div>
            <div v-else>
              {{ timeComputed }}
              倒计时{{ status == 'timeout' ? '已暂停' : status == 'end' ? '已结束' : '进行中...' }}
            </div>
          </el-col>
          <!-- 如果角色是助理:3 或者 是主讲人可以关闭 -->
          <span class="close ps" @click="onClose" v-if="permissionFlag">
            <i class="vh-iconfont vh-line-close"></i>
          </span>
        </el-row>
        <!-- 时间显示区 -->
        <el-row class="margin10 number_bg pr mt24 font_zdy">
          <div class="block-line ps"></div>

          <div class="number_mar timerbg">
            <span :class="time < 1 ? 'timeout_font_color' : ''">{{ ten_mon }}</span>
          </div>
          <div class="number_mar timerbg">
            <span :class="time < 1 ? 'timeout_font_color' : ''">{{ mon }}</span>
          </div>

          <span class="pr ft28" :class="time < 1 ? 'timeout_font_color' : ''">:</span>

          <div class="number_mar timerbg">
            <span :class="time < 1 ? 'timeout_font_color' : ''">{{ ten_sec }}</span>
          </div>
          <div class="number_mar timerbg">
            <span :class="time < 1 ? 'timeout_font_color' : ''">{{ sec }}</span>
          </div>
        </el-row>

        <el-row v-if="permissionFlag">
          <el-col align="center" class="mt20">
            <el-button
              round
              v-if="status == 'timeout'"
              type="primary"
              @click="goOn(5)"
              size="mini"
              class="button_width button_timeout"
            >
              继续
            </el-button>
            <el-button
              round
              v-else
              :disabled="(time == 0 && is_timeout == 0) || time == -3599"
              type="primary"
              @click="goOn(4)"
              size="mini"
              class="button_width button_timeout"
            >
              暂停
            </el-button>
            <el-button
              round
              type="primary"
              @click="resetTimer"
              size="mini"
              class="button_width button_reset"
            >
              重置
            </el-button>
          </el-col>
        </el-row>
      </el-row>
    </div>
  </div>
</template>

<script>
  import { useTimerServer, useMsgServer, useChatServer } from 'middle-domain';
  import { boxEventOpitons } from '@/packages/app-shared/utils/tool.js';
  export default {
    // props: ['timerInfo', 'rootActive', 'doc_permission'],
    name: 'VmpLiveTimer',
    directives: {
      drag(el) {
        el.onmousedown = function (e) {
          const disx = e.pageX - el.offsetLeft;
          const disy = e.pageY - el.offsetTop;
          document.onmousemove = function (e) {
            let l = e.pageX - disx;
            let t = e.pageY - disy;
            if (l < 230) {
              l = 230;
            }
            if (l > window.innerWidth - 170) {
              l = window.innerWidth - 170;
            }
            if (t < 5) {
              t = 5;
            }
            if (t > window.innerHeight - 240) {
              t = window.innerHeight - 240;
            }
            el.style.left = l + 'px';
            el.style.top = t + 'px';
          };
          document.onmouseup = function () {
            document.onmousemove = document.onmouseup = null;
          };
        };
      }
    },
    data() {
      return {
        status: 'start',
        totalTimeNum: 60,
        time: 0,
        timer: null,
        auth: 1,
        timerVisible: false,
        is_timeout: 0,
        is_all_show: 0,
        sec: 0,
        ten_sec: 0,
        mon: 0,
        ten_mon: 0
      };
    },
    computed: {
      // 自身信息获取
      userInfo() {
        return this.$domainStore.state.roomBaseServer.watchInitData.join_info;
      },
      //互动工具状态
      interactToolStatus() {
        const { interactToolStatus = {} } = this.$domainStore.state.roomBaseServer;
        return interactToolStatus;
      },
      // 小组信息获取
      groupInitData() {
        return this.$domainStore.state.groupServer.groupInitData;
      },
      // 主讲人id
      doc_permission() {
        let currentSpeakerId;
        if (this.groupInitData.isInGroup) {
          currentSpeakerId = this.groupInitData.doc_permission;
        } else {
          currentSpeakerId = this.interactToolStatus.doc_permission;
        }
        return currentSpeakerId;
      },
      /**
       * 权限控制
       * 当前用户角色 1-主持人 2-观众(发起端没有观众) 3-助理；4-嘉宾（互动直播才有嘉宾）
       * 如果角色是助理:3 或者 是主讲人可以关闭
       */
      permissionFlag() {
        //是否在分组里
        if (this.userInfo.role_name == 3) {
          return true;
        }
        if (this.userInfo.third_party_user_id == this.doc_permission) {
          return true;
        }
        return false;
      },
      // 总时间计算显示
      timeComputed() {
        return 60 > this.totalTimeNum
          ? this.totalTimeNum + '秒'
          : parseInt(this.totalTimeNum / 60) + '分' + (this.totalTimeNum % 60) + '秒';
      }
    },
    beforeCreate() {
      this.timerServer = useTimerServer();
      this.msgServer = useMsgServer();
    },
    mounted() {
      this.init();
      // this.timerServer.listenMsg();
      // console.log(this.timerServer, 'this.timerServer');
      // 计时器开始
      this.timerServer.$on('timer_start', temp => this.timer_start(temp));
      // 计时器结束
      this.timerServer.$on('timer_end', temp => this.timer_end(temp));
      // 计时器暂停
      this.timerServer.$on('timer_pause', temp => this.timer_pause(temp));
      // 计时器重置
      this.timerServer.$on('timer_reset', temp => this.timer_reset(temp));
      // 计时器继续
      this.timerServer.$on('timer_resume', temp => this.timer_resume(temp));
    },
    methods: {
      // 添加聊天记录
      addChatToList(e) {
        let str = '';
        switch (e.data.type) {
          case 'timer_start':
            str = '发起了计时器';
            break;
          case 'timer_end':
            str = '关闭了计时器';
            break;
          case 'timer_pause':
            str = '暂停了计时器';
            break;
          case 'timer_reset':
            str = '重置了计时器';
            break;
          case 'timer_resume':
            str = '继续了计时器';
            break;
        }
        const text = this.$getRoleName(e.data.role_name);
        const data = {
          nickname: '计时器',
          avatar: '//cnstatic01.e.vhall.com/static/images/watch/system.png',
          content: {
            text_content: `${text}${str}`
          },
          type: e.data.type
        };
        useChatServer().addChatToList(data);
      },
      // 计时器开始
      timer_start(e) {
        console.warn('监听到了计时器开始-------', e);
        this.timerVisible = true;
        this.status = 'start';
        this.time = e.data.duration;
        this.totalTimeNum = e.data.duration;
        this.is_timeout = e.data.is_timeout;
        this.is_all_show = e.data.is_all_show;
        this.timeFormat(Math.abs(this.time));
        this.timerFun(e.data.duration);
        // 禁用互动工具-计时器
        window.$middleEventSdk?.event?.send(
          boxEventOpitons(this.cuid, 'emitDisTimerIcon', ['disTimer', true])
        );
        this.addChatToList(e);
      },
      // 计时器结束
      timer_end(e) {
        console.warn('监听到了计时器结束-------', e);
        this.timerVisible = false;
        window.$middleEventSdk?.event?.send(
          boxEventOpitons(this.cuid, 'emitDisTimerIcon', ['disTimer', false])
        );
        // this.$emit('disTimer', true);
        clearInterval(this.timer);
        if (e.data.type == 'live_over') return;
        this.addChatToList(e);
      },
      // 计时器暂停
      timer_pause(e) {
        console.warn('监听到了计时器暂停-------', e);
        this.status = 'timeout';
        this.timeFormat(Math.abs(e.data.remain_time));
        clearInterval(this.timer);
        this.addChatToList(e);
      },
      // 计时器重置
      timer_reset(e) {
        console.warn('监听到了计时器重置-------', e);
        clearInterval(this.timer);
        this.timerVisible = false;
        // 关闭计时器
        // 主讲人助理打开计时设置弹框
        // this.$emit('disTimer', true);
        // if (
        //   this.userInfo.role_name == 3 ||
        //   this.userInfo.third_party_user_id == this.doc_permission
        // ) {
        //   this.$emit('openSetTimer');
        //   return false;
        // }
        this.addChatToList(e);
      },
      // 计时器继续
      timer_resume(e) {
        console.warn('监听到了计时器继续-------', e);
        this.status = 'start';
        this.timerFun(this.time);
        this.addChatToList(e);
      },
      init() {
        this.timerServer
          .getTimerInfo()
          .then(res => {
            if (JSON.stringify(res.data) != '{}') {
              console.log(res.data, 'timerInfo');
              const resData = res.data;
              this.time = resData.remain_time;
              this.totalTimeNum = resData.duration;
              this.is_timeout = resData.is_timeout;
              this.is_all_show = resData.is_all_show;
              this.timeFormat(Math.abs(this.time));
              this.timerVisible = true;
              if (resData.status != 4) {
                this.timerFun(this.time);
              }
              if (resData.status == 4) {
                this.status = 'timeout';
              }
              if (resData.status == 2) {
                this.status = 'end';
              }
              // 禁用互动工具-计时器
              window.$middleEventSdk?.event?.send(
                boxEventOpitons(this.cuid, 'emitDisTimerIcon', ['disTimer', true])
              );
              // this.$emit('disTimer', false);
            }
          })
          .catch(e => e);
      },
      // open关闭提示
      onClose() {
        this.$confirm('是否关闭计时器', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          customClass: 'zdy-message-box',
          cancelButtonClass: 'zdy-confirm-cancel'
        })
          .then(() => {
            this.closeTimerConfirm();
          })
          .catch(() => {});
      },
      // close关闭提示弹框
      closeTimerConfirm() {
        this.timerVisible = false;
        clearInterval(this.timer);
        this.editTimer(2);
      },
      // 秒转时间
      timeFormat(data) {
        this.sec = (data % 60) % 10;
        this.ten_sec = parseInt((data % 60) / 10);
        this.mon = parseInt(data / 60) % 10;
        this.ten_mon = parseInt(parseInt(data / 60) / 10);
      },
      // 计时函数
      timerFun(data) {
        if (this.timer) {
          clearInterval(this.timer);
          this.timer = null;
        }
        console.log(data);
        this.timer = setInterval(() => {
          if (this.is_timeout == 0) {
            if (data == 1) {
              this.status = 'end';
            }
            if (data == 0) {
              clearInterval(this.timer);
              return false;
            }
          }
          if (data == -3599) {
            clearInterval(this.timer);
            return false;
          }
          if (data < 1) {
            this.status = 'chaoshi';
          }
          this.timeFormat(Math.abs(--data));
          this.time = data;
        }, 1000);
      },
      // 暂停 || 继续
      goOn(status) {
        if (status == 4) {
          this.status = 'timeout';
          this.msgServer.sendCustomMsg({
            role_name: this.userInfo.role_name,
            type: 'timer_pause',
            remain_time: this.time
          });
        } else {
          this.status = this.time > 0 ? 'start' : 'chaoshi';
          this.timerFun(this.time);
        }
        this.editTimer(status);
      },
      // open重置弹框
      resetTimer() {
        this.$confirm('是否重新设置计时器？', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          customClass: 'zdy-message-box',
          cancelButtonClass: 'zdy-confirm-cancel'
        })
          .then(() => {
            this.resetTimerConfirmClose();
          })
          .catch(() => {});
      },
      // 重置时间
      resetTimerConfirmClose() {
        this.timerVisible = false;
        window.$middleEventSdk?.event?.send(boxEventOpitons(this.cuid, 'emitOpenTimerSet'));
        clearInterval(this.timer);
        this.status = 'start';
        this.editTimer(3);
      },
      // 操作计时器
      editTimer(status) {
        this.timerServer
          .timerEdit({
            action_type: status,
            duration: this.totalTimeNum || this.time,
            remain_time: this.time,
            is_all_show: this.is_all_show ? 1 : 0,
            is_timeout: this.is_timeout ? 1 : 0
          })
          .then(res => {
            console.log(res);
          });
      }
    }
  };
</script>

<style lang="less">
  @import url(./style.less);
  .ft14 {
    font-size: 14px;
  }
  .vmp-live-timer {
    .button_width {
      padding: 9px 34px !important;
      color: #fff;
    }
    .button_timeout,
    .button_timeout:hover {
      border: 1px solid #595959 !important;
      background: #595959 !important;
    }
    .button_reset {
      border: 1px solid @font-high-light-normal;
      background: @font-high-light-normal;
    }
    .start_font_color {
      color: #0fbb5a;
    }
    .pause_font_color {
      color: #fc9600;
    }
    .timeout_font_color {
      color: @font-high-light-normal;
    }
    .mt20 {
      margin-top: 20px;
    }
    .mt24 {
      margin-top: 24px;
    }
    .background-img {
      width: 292px;
      position: fixed;
      z-index: 102;
      padding: 24px 20px;
      top: 15vh;
      left: 50vw;
      transform: translate(-50%, 0);
      color: #fff;
      background-image: linear-gradient(#fffaee, #fff6d5);
      border-radius: 20px;
    }
    .timerbg {
      display: inline-block;
      background: url('./img/timerbg.png');
      height: 75px;
      width: 53px;
      position: relative;
      & > :first-child {
        font-size: 38px;
        position: absolute;
        font-weight: bold;
        top: 15px;
        left: 14px;
      }
    }
    .padding45 {
      padding: 0 20px;
    }
    .margin10 {
      border-radius: 4px;
      height: 83px;
      text-align: center;
    }
    .ps {
      position: absolute;
    }
    .block-line {
      border-top: 4px solid #000;
      top: 40px;
      z-index: 999;
      width: 100%;
    }
    .number_bg {
      background: #000;
      .ft28 {
        font-size: 28px;
        top: -33px;
        font-weight: bold;
      }
    }
    .close {
      margin-right: 11px;
      margin-top: 11px;
      cursor: pointer;
      width: 20px;
      height: 20px;
      opacity: 0.8;
      position: absolute;
      right: -35px;
      top: -10px;
      color: #666;
      & > i {
        font-size: 10px;
        float: right;
        line-height: 20px;
      }
    }
    .number_mar {
      box-sizing: border-box;
      margin: 4px 3px;
    }
    .pr {
      position: relative;
    }
  }
</style>
